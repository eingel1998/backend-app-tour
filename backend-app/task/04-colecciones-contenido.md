# 04 - COLECCIONES DE CONTENIDO üèõÔ∏è

## üéØ OBJETIVO
Implementar las colecciones de contenido tur√≠stico: Places (lugares tur√≠sticos), Reviews (rese√±as) y Events (eventos). Estas colecciones manejan el contenido principal de la aplicaci√≥n tur√≠stica de Riohacha.

## üìã PREREQUISITOS
- [‚úÖ] Tarea 03 - Colecciones b√°sicas completada
- [‚úÖ] Users, Media y Categories funcionando
- [‚úÖ] Seeds b√°sicos cargados

## üóÇÔ∏è ESTADO ACTUAL
üü° **PENDIENTE** - No iniciado

---

## üìù TAREAS ESPEC√çFICAS

### 1. COLECCI√ìN PLACES (LUGARES TUR√çSTICOS) üèñÔ∏è
**Archivo:** `src/collections/Places.ts`

- [ ] **1.1** - Crear estructura b√°sica de la colecci√≥n Places
- [ ] **1.2** - Configurar campos principales:
  ```typescript
  // name, slug, description, shortDescription, category, subcategory, tags
  ```

- [ ] **1.3** - Implementar grupo `location` con coordenadas:
  ```typescript
  // address, latitude, longitude, city, department
  // accessInstructions, publicTransport, parkingAvailable
  ```

- [ ] **1.4** - Configurar relaciones multimedia:
  ```typescript
  // images: relationship (many) -> media (requerido)
  // videos: relationship (many) -> media
  // virtualTour: text (URL 360¬∞)
  ```

- [ ] **1.5** - Implementar grupo `pricing`:
  ```typescript
  // isFree, minPrice, maxPrice, currency, priceDescription
  ```

- [ ] **1.6** - Configurar array `schedule` para horarios:
  ```typescript
  // day, openTime, closeTime, isClosed, isOpen24h, seasonalNotes
  ```

- [ ] **1.7** - Implementar grupo `accessibility`:
  ```typescript
  // wheelchairAccessible, hasParking, hasRestrooms, hasFood, allowsPets, childFriendly
  ```

- [ ] **1.8** - Configurar array `features` para caracter√≠sticas especiales
- [ ] **1.9** - Implementar grupo `statistics` (solo lectura, calculado):
  ```typescript
  // averageRating, totalReviews, totalViews, totalFavorites, lastReviewDate
  ```

- [ ] **1.10** - Configurar relaciones:
  ```typescript
  // businessOwner: relationship (one) -> users (donde userType='business')
  // relatedPlaces: relationship (many) -> places
  ```

- [ ] **1.11** - Implementar campos de estado:
  ```typescript
  // status: ['draft', 'published', 'archived']
  // isActive, isFeatured, isVerified, verificationDate
  ```

- [ ] **1.12** - Configurar hooks para auto-generaci√≥n de slug
- [ ] **1.13** - Configurar Access Control (p√∫blicos para lectura, empresas para crear sus lugares)

### 2. COLECCI√ìN REVIEWS (RESE√ëAS) ‚≠ê
**Archivo:** `src/collections/Reviews.ts`

- [ ] **2.1** - Crear estructura b√°sica de la colecci√≥n Reviews
- [ ] **2.2** - Configurar campos principales:
  ```typescript
  // user: relationship -> users, place: relationship -> places
  // rating: number (1-5), title, comment, pros, cons
  ```

- [ ] **2.3** - Configurar multimedia de evidencia:
  ```typescript
  // images: relationship (many) -> media (m√°x 5)
  // visitDate, tripType: ['solo', 'couple', 'family', 'friends', 'business']
  ```

- [ ] **2.4** - Implementar grupo `ratings` para valoraciones detalladas:
  ```typescript
  // cleanliness: number (1-5), service: number (1-5)
  // value: number (1-5), accessibility: number (1-5)
  ```

- [ ] **2.5** - Configurar campos de estado y moderaci√≥n:
  ```typescript
  // status: ['pending', 'approved', 'rejected', 'flagged']
  // isVerified, isVisible, moderationNotes, flagReason
  ```

- [ ] **2.6** - Implementar interacciones:
  ```typescript
  // helpfulVotes, notHelpfulVotes, reportCount
  ```

- [ ] **2.7** - Configurar array `responses` para respuestas de empresas:
  ```typescript
  // user: relationship -> users (business owner)
  // response, responseDate, isOfficial
  ```

- [ ] **2.8** - Implementar √≠ndice √∫nico `user + place` (una rese√±a por usuario por lugar)
- [ ] **2.9** - Configurar hooks para actualizar estad√≠sticas de Places
- [ ] **2.10** - Configurar Access Control (usuarios autenticados para crear, moderadores para aprobar)

### 3. COLECCI√ìN EVENTS (EVENTOS) üé≠
**Archivo:** `src/collections/Events.ts`

- [ ] **3.1** - Crear estructura b√°sica de la colecci√≥n Events
- [ ] **3.2** - Configurar campos principales:
  ```typescript
  // name, slug, description, shortDescription, eventType, category, tags
  ```

- [ ] **3.3** - Implementar grupo `schedule` para programaci√≥n:
  ```typescript
  // startDate, endDate, startTime, endTime, timezone
  // duration, isRecurring, recurrencePattern
  ```

- [ ] **3.4** - Configurar grupo `location` para ubicaci√≥n del evento:
  ```typescript
  // locationType: ['place', 'custom', 'multiple', 'online']
  // place: relationship -> places (si locationType='place')
  // customLocation: { name, address, latitude, longitude, city }
  // onlineDetails: { platform, url, accessCode }
  ```

- [ ] **3.5** - Implementar grupo `organizer`:
  ```typescript
  // organizerType: ['business', 'government', 'ngo', 'individual']
  // organizer: relationship -> users
  // organizerName, contact: { email, phone, website }
  ```

- [ ] **3.6** - Configurar grupo `pricing` para tickets y reservas:
  ```typescript
  // isFree, ticketPrice, currency, hasDiscounts, discountDescription
  // requiresReservation, maxAttendees, currentAttendees
  ```

- [ ] **3.7** - Configurar multimedia:
  ```typescript
  // images: relationship (many) -> media
  // videos: relationship (many) -> media
  // poster: upload (imagen principal)
  ```

- [ ] **3.8** - Implementar campos de estado:
  ```typescript
  // status: ['draft', 'published', 'cancelled', 'postponed', 'completed']
  // isActive, isFeatured, isRecurring, cancellationReason, isApproved
  ```

- [ ] **3.9** - Configurar hooks para validaci√≥n de fechas y disponibilidad
- [ ] **3.10** - Configurar Access Control (empresas y organizadores para crear)

### 4. SEEDS PARA CONTENIDO DE RIOHACHA
**Archivo:** `src/seeds/contentCollections.ts`

- [ ] **4.1** - Crear seeds para lugares emblem√°ticos de Riohacha:
  ```typescript
  const places = [
    {
      name: 'Muelle de Riohacha',
      description: 'Hermoso muelle con vista al atardecer sobre el mar Caribe',
      category: 'playas-y-costas',
      location: { latitude: 11.5447, longitude: -72.9072, address: 'Muelle de Riohacha' },
      isFree: true,
      features: ['Atardeceres', 'Fotograf√≠a', 'Caminatas']
    },
    {
      name: 'Playa de Riohacha',
      description: 'Playa principal de la ciudad con aguas c√°lidas',
      category: 'playas-y-costas',
      location: { latitude: 11.5388, longitude: -72.9156 }
    },
    // ... m√°s lugares
  ]
  ```

- [ ] **4.2** - Crear eventos t√≠picos de Riohacha:
  ```typescript
  const events = [
    {
      name: 'Festival de la Cultura Wayuu',
      eventType: 'cultural',
      description: 'Celebraci√≥n de la cultura ind√≠gena Wayuu',
      schedule: { startDate: '2024-08-15', duration: '3 d√≠as' }
    },
    // ... m√°s eventos
  ]
  ```

- [ ] **4.3** - Crear rese√±as de ejemplo para testing
- [ ] **4.4** - Ejecutar seeds y verificar relaciones correctas

### 5. CONFIGURACI√ìN DE B√öSQUEDA
- [ ] **5.1** - Configurar √≠ndices de b√∫squeda en Places:
  - name, description, shortDescription, tags
  - location.address, location.city

- [ ] **5.2** - Configurar filtros comunes para Places:
  - Por categor√≠a, por precio, por ubicaci√≥n
  - Por caracter√≠sticas de accesibilidad

- [ ] **5.3** - Configurar b√∫squeda en Events:
  - Por fecha, por tipo de evento, por ubicaci√≥n

### 6. VALIDACIONES Y HOOKS AVANZADOS
- [ ] **6.1** - Hook en Places para validar coordenadas dentro de La Guajira
- [ ] **6.2** - Hook en Reviews para prevenir spam (m√°ximo 1 rese√±a por d√≠a por usuario)
- [ ] **6.3** - Hook en Events para validar fechas futuras
- [ ] **6.4** - Hook en Places para actualizar estad√≠sticas cuando se crea una review
- [ ] **6.5** - Hook en Events para notificar cuando se cancela un evento

---

## ‚úÖ CRITERIOS DE ACEPTACI√ìN

### Colecci√≥n Places
- [ ] CRUD completo funciona via API y admin
- [ ] Relaciones con Categories y Media funcionan
- [ ] Geolocalizaci√≥n funciona correctamente
- [ ] Horarios y precios se configuran apropiadamente
- [ ] BusinessOwner puede gestionar sus lugares
- [ ] B√∫squeda por ubicaci√≥n funciona

### Colecci√≥n Reviews
- [ ] Usuarios pueden crear rese√±as
- [ ] Sistema de ratings detallados funciona
- [ ] √çndice √∫nico user+place previene duplicados
- [ ] Empresas pueden responder a rese√±as
- [ ] Estad√≠sticas de Places se actualizan autom√°ticamente
- [ ] Sistema de moderaci√≥n funciona

### Colecci√≥n Events
- [ ] Eventos se crean con diferentes tipos de ubicaci√≥n
- [ ] Sistema de fechas y recurrencia funciona
- [ ] Organizers pueden gestionar sus eventos
- [ ] Sistema de tickets y reservas b√°sico funciona
- [ ] Estados de eventos se gestionan correctamente

### Integraci√≥n General
- [ ] Seeds de Riohacha se cargan correctamente
- [ ] Todas las relaciones funcionan
- [ ] Admin UI muestra todas las colecciones
- [ ] APIs REST completas disponibles
- [ ] B√∫squedas y filtros funcionan

---

## üõ†Ô∏è COMANDOS √öTILES

### Desarrollo
```bash
# Generar tipos despu√©s de crear colecciones
npm run generate:types

# Ejecutar seeds de contenido
npm run seed:content

# Verificar relaciones en admin
npm run dev
```

### Testing API
```bash
# Crear lugar tur√≠stico
curl -X POST http://localhost:3000/api/places \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Muelle de Riohacha",
    "description": "Hermoso muelle con vista al atardecer",
    "location": {"latitude": 11.5447, "longitude": -72.9072},
    "category": "ID_CATEGORIA"
  }'

# Buscar lugares por categor√≠a
curl "http://localhost:3000/api/places?where[category][equals]=ID_CATEGORIA"

# Crear rese√±a
curl -X POST http://localhost:3000/api/reviews \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer TOKEN" \
  -d '{
    "place": "ID_LUGAR",
    "rating": 5,
    "comment": "Excelente lugar para ver el atardecer"
  }'

# Listar eventos activos
curl "http://localhost:3000/api/events?where[status][equals]=published&where[isActive][equals]=true"
```

### Verificaci√≥n de Datos
```bash
# Ver lugares creados
sqlite3 backend-app.db "SELECT name, status FROM places LIMIT 5;"

# Ver rese√±as con relaciones
sqlite3 backend-app.db "SELECT r.rating, r.comment, p.name FROM reviews r JOIN places p ON r.place = p.id LIMIT 3;"

# Ver eventos pr√≥ximos
sqlite3 backend-app.db "SELECT name, startDate FROM events WHERE startDate > date('now') LIMIT 5;"
```

---

## üìù NOTAS T√âCNICAS

### Geolocalizaci√≥n en Places
```typescript
// Validaci√≥n de coordenadas para La Guajira
{
  name: 'latitude',
  type: 'number',
  required: true,
  validate: (val) => {
    // La Guajira bounds aproximados
    return val >= 10.0 && val <= 12.5;
  }
}
```

### Estad√≠sticas Calculadas
```typescript
// Hook para actualizar estad√≠sticas de Places
const updatePlaceStats = async (placeId) => {
  const reviews = await payload.find({
    collection: 'reviews',
    where: { place: { equals: placeId }, status: { equals: 'approved' } }
  });
  
  const averageRating = reviews.docs.reduce((acc, r) => acc + r.rating, 0) / reviews.docs.length;
  
  await payload.update({
    collection: 'places',
    id: placeId,
    data: {
      'statistics.averageRating': averageRating,
      'statistics.totalReviews': reviews.totalDocs
    }
  });
};
```

### Prevenci√≥n de Spam en Reviews
```typescript
// Hook beforeValidate en Reviews
beforeValidate: [
  async ({ data, req }) => {
    const recentReview = await req.payload.find({
      collection: 'reviews',
      where: {
        user: { equals: req.user.id },
        createdAt: { greater_than: new Date(Date.now() - 24 * 60 * 60 * 1000) }
      }
    });
    
    if (recentReview.totalDocs >= 3) {
      throw new Error('M√°ximo 3 rese√±as por d√≠a permitidas');
    }
  }
]
```

---

## üö® PROBLEMAS COMUNES

### Error: "Duplicate key violation"
- **Causa:** Intentar crear rese√±a duplicada (user + place)
- **Soluci√≥n:** Verificar √≠ndice √∫nico y validar antes de crear

### Error: "Invalid coordinates"
- **Causa:** Coordenadas fuera del rango de La Guajira
- **Soluci√≥n:** Validar bounds en hook beforeValidate

### Error: "Event date in the past"
- **Causa:** Crear evento con fecha pasada
- **Soluci√≥n:** Validar fechas en hook beforeValidate

### Error: "Business owner mismatch"
- **Causa:** Usuario no-business intentando crear lugar con businessOwner
- **Soluci√≥n:** Validar userType en Access Control

---

## üìã CHECKLIST DE COMPLETITUD

Al finalizar esta tarea, deber√≠as tener:

- [ ] ‚úÖ Colecci√≥n Places completa con geolocalizaci√≥n
- [ ] ‚úÖ Colecci√≥n Reviews con sistema de ratings
- [ ] ‚úÖ Colecci√≥n Events con programaci√≥n avanzada
- [ ] ‚úÖ Seeds de lugares tur√≠sticos de Riohacha
- [ ] ‚úÖ Seeds de eventos t√≠picos de La Guajira
- [ ] ‚úÖ Sistema de b√∫squeda y filtros funcionando
- [ ] ‚úÖ Relaciones entre todas las colecciones
- [ ] ‚úÖ Hooks de validaci√≥n y estad√≠sticas
- [ ] ‚úÖ Access Control apropiado para cada collection
- [ ] ‚úÖ APIs REST completas para las 3 colecciones

**Estado:** üü° PENDIENTE ‚Üí ‚úÖ COMPLETADO

**Siguiente tarea:** `05-colecciones-avanzadas.md`

## üß™ TESTS ESPEC√çFICOS DE LA TAREA

### Tests Obligatorios para Completar la Tarea
Esta tarea solo estar√° **COMPLETA** cuando **TODOS** los siguientes tests pasen:

#### **üìÅ Estructura de Tests: `test/tasks/task-04/`**

##### **1. `places-collection.test.ts` - Tests de Colecci√≥n Places**
```typescript
describe('Task 04 - Places Collection', () => {
  test('should have Places collection with complete structure', async () => {
    // Verificar estructura b√°sica de Places.ts
    // Validar campos principales: name, slug, description, etc.
    // Verificar relaci√≥n con categories
  });

  test('should handle location data correctly', async () => {
    // Test de grupo location con coordenadas
    // Verificar validaci√≥n de latitude/longitude
    // Test de campos de acceso y transporte
  });

  test('should manage multimedia relationships properly', async () => {
    // Test de relaci√≥n con Media (images, videos)
    // Verificar campo virtualTour para URLs 360¬∞
    // Validar requerimientos de im√°genes
  });

  test('should handle pricing configuration', async () => {
    // Test de grupo pricing (isFree, precios)
    // Verificar validaci√≥n de moneda
    // Test de descripciones de precios
  });

  test('should manage schedule and accessibility data', async () => {
    // Test de array schedule para horarios
    // Verificar configuraci√≥n de d√≠as y horarios
    // Test de grupo accessibility
  });

  test('should validate Riohacha tourism places creation', async () => {
    // Test de creaci√≥n de lugares espec√≠ficos de Riohacha
    // Verificar datos geogr√°ficos correctos
    // Validar categorizaci√≥n apropiada
  });
});
```

##### **2. `reviews-collection.test.ts` - Tests de Colecci√≥n Reviews**
```typescript
describe('Reviews Collection Tests', () => {
  test('should have Reviews collection with rating system', async () => {
    // Verificar estructura de Reviews.ts
    // Test de sistema de calificaci√≥n (1-5 estrellas)
    // Validar campos de rese√±a: title, content, rating
  });

  test('should handle user and place relationships', async () => {
    // Test de relaci√≥n user -> reviews
    // Test de relaci√≥n place -> reviews
    // Verificar integridad referencial
  });

  test('should manage review moderation', async () => {
    // Test de estados de moderaci√≥n
    // Verificar workflow de aprobaci√≥n
    // Test de filtrado de contenido inapropiado
  });

  test('should calculate average ratings correctly', async () => {
    // Test de c√°lculo de rating promedio por lugar
    // Verificar actualizaci√≥n autom√°tica de promedios
    // Test de distribuci√≥n de calificaciones
  });

  test('should handle review responses and interactions', async () => {
    // Test de respuestas de negocios
    // Verificar sistema de likes/dislikes
    // Test de reportes de rese√±as
  });

  test('should validate review authenticity', async () => {
    // Test de validaci√≥n de usuario autenticado
    // Verificar una rese√±a por usuario por lugar
    // Test de detecci√≥n de reviews spam
  });
});
```

##### **3. `events-collection.test.ts` - Tests de Colecci√≥n Events**
```typescript
describe('Events Collection Tests', () => {
  test('should have Events collection with date management', async () => {
    // Verificar estructura de Events.ts
    // Test de campos de fecha: startDate, endDate
    // Validar manejo de eventos recurrentes
  });

  test('should handle event location and venue data', async () => {
    // Test de relaci√≥n con Places (venue)
    // Verificar datos de ubicaci√≥n espec√≠fica
    // Test de capacidad y aforo
  });

  test('should manage event categories and types', async () => {
    // Test de categorizaci√≥n de eventos
    // Verificar tipos espec√≠ficos de Riohacha (culturales, gastron√≥micos)
    // Test de tags y etiquetado
  });

  test('should handle registration and ticketing', async () => {
    // Test de sistema de registro
    // Verificar manejo de tickets y precios
    // Test de l√≠mites de capacidad
  });

  test('should manage event organizer data', async () => {
    // Test de relaci√≥n con Users (organizer)
    // Verificar permisos de organizaci√≥n
    // Test de contacto y informaci√≥n del organizador
  });

  test('should handle event status and lifecycle', async () => {
    // Test de estados: draft, published, ongoing, finished, cancelled
    // Verificar transiciones de estado autom√°ticas
    // Test de notificaciones por cambios de estado
  });
});
```

##### **4. `content-integration.test.ts` - Tests de Integraci√≥n de Contenido**
```typescript
describe('Content Collections Integration Tests', () => {
  test('should integrate all content collections properly', async () => {
    // Test de integraci√≥n Places + Reviews + Events
    // Verificar relaciones cruzadas
    // Test de queries complejas entre colecciones
  });

  test('should handle search and filtering across collections', async () => {
    // Test de b√∫squeda global en contenido
    // Verificar filtros por categor√≠a, ubicaci√≥n, fecha
    // Test de b√∫squeda por texto en m√∫ltiples campos
  });

  test('should manage content moderation workflow', async () => {
    // Test de workflow de moderaci√≥n unificado
    // Verificar permisos de publicaci√≥n
    // Test de contenido reportado
  });

  test('should handle content recommendations', async () => {
    // Test de recomendaciones relacionadas
    // Verificar algoritmo de contenido similar
    // Test de recomendaciones basadas en ubicaci√≥n
  });

  test('should support multilingual content', async () => {
    // Test de contenido en espa√±ol e ingl√©s
    // Verificar traducci√≥n de campos
    // Test de fallback de idiomas
  });
});
```

##### **5. `content-performance.test.ts` - Tests de Rendimiento de Contenido**
```typescript
describe('Content Performance Tests', () => {
  test('should handle large content datasets efficiently', async () => {
    // Test con muchos lugares tur√≠sticos
    // Verificar performance de queries complejas
    // Test de paginaci√≥n eficiente
  });

  test('should optimize media loading for places', async () => {
    // Test de lazy loading de im√°genes
    // Verificar optimizaci√≥n de queries de media
    // Test de cache de multimedia
  });

  test('should handle concurrent reviews and ratings', async () => {
    // Test de m√∫ltiples rese√±as simult√°neas
    // Verificar integridad de c√°lculos de rating
    // Test de performance en updates de promedios
  });

  test('should optimize event queries by date range', async () => {
    // Test de queries de eventos por rango de fechas
    // Verificar √≠ndices temporales
    // Test de performance en eventos recurrentes
  });
});
```

### **üìä Comandos de Validaci√≥n**

#### **Ejecutar Tests de la Tarea 04:**
```bash
npm run test:task-04
```

#### **Ejecutar Tests con Coverage:**
```bash
npm run test:task-04:coverage
```

#### **Validaci√≥n Autom√°tica de Completitud:**
```bash
node scripts/validate-task.js 04
```

### **‚úÖ Criterios de Completitud**
- [ ] üß™ **TODOS los tests pasan** (100% success rate)
- [ ] üìä **Coverage >80%** en colecciones de contenido
- [ ] üîç **Validaci√≥n autom√°tica exitosa** con `validate-task.js 04`
- [ ] üìÅ **Colecciones registradas** y funcionando
- [ ] ‚ö° **Performance tests pasan** con datasets grandes
- [ ] üîó **Tests de integraci√≥n exitosos** entre colecciones

---

## ‚ö†Ô∏è IMPORTANTE
**Esta tarea NO estar√° completa hasta que TODOS los tests pasen exitosamente.**

El comando `npm run test:task-04` debe ejecutarse sin errores y todos los tests deben estar en estado ‚úÖ PASSED.

---
