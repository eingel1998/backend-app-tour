# 07 - ENDPOINTS PERSONALIZADOS üöÄ

## üéØ OBJETIVO
Crear endpoints API personalizados m√°s all√° de los CRUD b√°sicos de Payload, incluyendo b√∫squedas avanzadas, geolocalizaci√≥n, estad√≠sticas, integraci√≥n con servicios externos y funcionalidades espec√≠ficas para el turismo en Riohacha.

## üìã PREREQUISITOS
- [‚úÖ] Tarea 06 - Autenticaci√≥n y autorizaci√≥n completada
- [‚úÖ] Todas las colecciones funcionando
- [ ] Sistema de auth implementado

## üóÇÔ∏è ESTADO ACTUAL
üü° **PENDIENTE** - No iniciado

---

## üìù TAREAS ESPEC√çFICAS

### 1. ENDPOINTS DE B√öSQUEDA AVANZADA
**Archivo:** `src/endpoints/search.ts`

- [ ] **1.1** - Crear endpoint `/api/search/places` para b√∫squeda inteligente:
  ```typescript
  // GET: b√∫squeda de lugares con m√∫ltiples criterios
  // Par√°metros: query, category, location, radius, priceRange, rating
  // Funciones: texto libre, filtros combinados, ordenamiento
  ```

- [ ] **1.2** - Implementar b√∫squeda por texto en m√∫ltiples campos:
  ```typescript
  // Buscar en: name, description, tags, address
  // Implementar relevancia scoring
  // Soporte para t√©rminos en espa√±ol y wayuunaiki
  ```

- [ ] **1.3** - Crear endpoint `/api/search/nearby` para b√∫squeda geogr√°fica:
  ```typescript
  // GET: lugares cercanos a coordenadas
  // Par√°metros: lat, lng, radius (km), category
  // Ordenar por distancia, incluir distancia calculada
  ```

- [ ] **1.4** - Crear endpoint `/api/search/recommendations` para b√∫squeda de recomendaciones:
  ```typescript
  // GET: buscar recomendaciones p√∫blicas
  // Filtros: type, theme, duration, budget
  // Soporte para usuarios sin autenticar
  ```

- [ ] **1.5** - Implementar endpoint `/api/search/events` para eventos:
  ```typescript
  // GET: eventos por fecha, ubicaci√≥n, tipo
  // Filtros: dateRange, location, eventType, isFree
  // Soporte para eventos recurrentes
  ```

### 2. ENDPOINTS DE GEOLOCALIZACI√ìN
**Archivo:** `src/endpoints/geolocation.ts`

- [ ] **2.1** - Crear endpoint `/api/geo/reverse` para geocodificaci√≥n inversa:
  ```typescript
  // POST: obtener direcci√≥n desde coordenadas
  // Integraci√≥n con servicio de mapas (OpenStreetMap/Google)
  // Validar coordenadas dentro de La Guajira
  ```

- [ ] **2.2** - Crear endpoint `/api/geo/distance` para c√°lculo de distancias:
  ```typescript
  // POST: calcular distancia entre m√∫ltiples puntos
  // Algoritmo haversine para precisi√≥n geogr√°fica
  // Retornar distancia en km y tiempo estimado
  ```

- [ ] **2.3** - Crear endpoint `/api/geo/route` para rutas optimizadas:
  ```typescript
  // POST: generar ruta optimizada entre lugares
  // Par√°metros: lugares array, transportation mode
  // Integraci√≥n con servicios de routing
  ```

- [ ] **2.4** - Implementar endpoint `/api/geo/boundaries` para l√≠mites geogr√°ficos:
  ```typescript
  // GET: obtener l√≠mites geogr√°ficos de Riohacha y La Guajira
  // √ötil para validaciones y mapas en frontend
  ```

### 3. ENDPOINTS DE ESTAD√çSTICAS Y ANALYTICS
**Archivo:** `src/endpoints/analytics.ts`

- [ ] **3.1** - Crear endpoint `/api/analytics/places` para estad√≠sticas de lugares:
  ```typescript
  // GET: estad√≠sticas generales de lugares
  // M√©tricas: m√°s visitados, mejor valorados, por categor√≠a
  // Filtros por per√≠odo de tiempo
  ```

- [ ] **3.2** - Crear endpoint `/api/analytics/trends` para tendencias:
  ```typescript
  // GET: tendencias de b√∫squedas y visitas
  // Lugares trending, categor√≠as populares
  // An√°lisis temporal (d√≠a, semana, mes)
  ```

- [ ] **3.3** - Implementar endpoint `/api/analytics/dashboard` para admin:
  ```typescript
  // GET: dashboard completo para administradores
  // Usuarios activos, lugares m√°s populares, rese√±as recientes
  // Solo accesible para admins
  ```

- [ ] **3.4** - Crear endpoint `/api/analytics/business/:businessId` para empresas:
  ```typescript
  // GET: estad√≠sticas espec√≠ficas de empresa
  // Visitas, rese√±as, rating promedio
  // Solo accesible por el propietario y admins
  ```

### 4. ENDPOINTS DE INTEGRACI√ìN EXTERNA
**Archivo:** `src/endpoints/integrations.ts`

- [ ] **4.1** - Crear endpoint `/api/integrations/weather` para clima:
  ```typescript
  // GET: informaci√≥n meteorol√≥gica de Riohacha
  // Integraci√≥n con API de clima (OpenWeatherMap)
  // Cache de respuestas por 1 hora
  ```

- [ ] **4.2** - Implementar endpoint `/api/integrations/currency` para cambio de moneda:
  ```typescript
  // GET: conversi√≥n COP a USD y otras monedas
  // √ötil para turistas internacionales
  // Cache diario de tasas de cambio
  ```

- [ ] **4.3** - Crear endpoint `/api/integrations/translate` para traducciones:
  ```typescript
  // POST: traducir textos a wayuunaiki e ingl√©s
  // √ötil para contenido multiidioma
  // Cache de traducciones comunes
  ```

- [ ] **4.4** - Implementar endpoint `/api/integrations/social` para compartir:
  ```typescript
  // POST: generar contenido optimizado para redes sociales
  // Crear im√°genes con metadata, links optimizados
  // Integraci√≥n con Open Graph
  ```

### 5. ENDPOINTS DE UTILIDADES ESPEC√çFICAS
**Archivo:** `src/endpoints/utilities.ts`

- [ ] **5.1** - Crear endpoint `/api/utils/validate` para validaciones:
  ```typescript
  // POST: validar diferentes tipos de datos
  // RUT/NIT empresarial, coordenadas, emails
  // √ötil para validaci√≥n en tiempo real en frontend
  ```

- [ ] **5.2** - Implementar endpoint `/api/utils/slugify` para URLs amigables:
  ```typescript
  // POST: generar slugs √∫nicos para lugares y eventos
  // Manejo de caracteres especiales y wayuunaiki
  // Verificaci√≥n de unicidad
  ```

- [ ] **5.3** - Crear endpoint `/api/utils/qr` para c√≥digos QR:
  ```typescript
  // POST: generar c√≥digos QR para lugares y eventos
  // Incluir informaci√≥n b√°sica y enlace a app
  // √ötil para marketing f√≠sico
  ```

- [ ] **5.4** - Implementar endpoint `/api/utils/export` para exportaciones:
  ```typescript
  // GET: exportar datos en diferentes formatos
  // Soportar CSV, JSON, PDF para reportes
  // Control de permisos por tipo de usuario
  ```

### 6. ENDPOINTS DE NOTIFICACIONES
**Archivo:** `src/endpoints/notifications.ts`

- [ ] **6.1** - Crear endpoint `/api/notifications/send` para notificaciones push:
  ```typescript
  // POST: enviar notificaciones push a usuarios
  // Filtros por ubicaci√≥n, intereses, tipo de usuario
  // Integraci√≥n con FCM (Firebase Cloud Messaging)
  ```

- [ ] **6.2** - Implementar endpoint `/api/notifications/email` para emails:
  ```typescript
  // POST: enviar emails promocionales y informativos
  // Templates para diferentes tipos de notificaciones
  // Respeto por preferencias de usuario
  ```

- [ ] **6.3** - Crear endpoint `/api/notifications/sms` para SMS:
  ```typescript
  // POST: enviar SMS para alertas importantes
  // Solo para emergencias y confirmaciones cr√≠ticas
  // Integraci√≥n con servicio SMS local
  ```

### 7. ENDPOINTS DE REPORTES Y MODERACI√ìN
**Archivo:** `src/endpoints/moderation.ts`

- [ ] **7.1** - Crear endpoint `/api/moderation/reports` para reportes:
  ```typescript
  // POST: reportar contenido inapropiado
  // GET: listar reportes para moderadores
  // Tipos: spam, contenido ofensivo, informaci√≥n incorrecta
  ```

- [ ] **7.2** - Implementar endpoint `/api/moderation/approve` para aprobaciones:
  ```typescript
  // POST: aprobar/rechazar lugares, rese√±as, eventos
  // Solo accesible para moderadores y admins
  // Incluir notas de moderaci√≥n
  ```

- [ ] **7.3** - Crear endpoint `/api/moderation/bulk` para acciones en masa:
  ```typescript
  // POST: aplicar acciones a m√∫ltiples elementos
  // Aprobar/rechazar en lotes, cambiar estados
  // Logging detallado de acciones masivas
  ```

### 8. HEALTH CHECKS Y MONITOREO
**Archivo:** `src/endpoints/health.ts`

- [ ] **8.1** - Crear endpoint `/api/health` para health check general:
  ```typescript
  // GET: estado general del sistema
  // Verificar: database, external APIs, disk space
  // Formato est√°ndar para monitoring tools
  ```

- [ ] **8.2** - Implementar endpoint `/api/health/database` para DB:
  ```typescript
  // GET: estado espec√≠fico de la base de datos
  // Tiempo de respuesta, conexiones activas
  // Verificar integridad de tablas principales
  ```

- [ ] **8.3** - Crear endpoint `/api/health/services` para servicios externos:
  ```typescript
  // GET: estado de integraciones externas
  // Verificar APIs de clima, mapas, traducciones
  // Tiempo de respuesta y disponibilidad
  ```

---

## ‚úÖ CRITERIOS DE ACEPTACI√ìN

### B√∫squeda Avanzada
- [ ] B√∫squeda de texto libre funciona correctamente
- [ ] Filtros combinados funcionan apropiadamente
- [ ] B√∫squeda geogr√°fica retorna resultados precisos
- [ ] Ordenamiento por relevancia y distancia funciona

### Geolocalizaci√≥n
- [ ] Geocodificaci√≥n inversa funciona
- [ ] C√°lculo de distancias es preciso
- [ ] Rutas optimizadas se generan correctamente
- [ ] Validaci√≥n de coordenadas funciona

### Estad√≠sticas y Analytics
- [ ] M√©tricas se calculan correctamente
- [ ] Dashboard de admin muestra datos relevantes
- [ ] Estad√≠sticas de empresa son precisas
- [ ] Performance de queries es aceptable

### Integraciones Externas
- [ ] API de clima retorna datos actuales
- [ ] Conversi√≥n de moneda funciona
- [ ] Traducciones b√°sicas funcionan
- [ ] Compartir en redes sociales funciona

### Utilidades y Herramientas
- [ ] Validaciones en tiempo real funcionan
- [ ] Generaci√≥n de QR codes funciona
- [ ] Exportaciones en m√∫ltiples formatos
- [ ] Notificaciones se env√≠an correctamente

---

## üõ†Ô∏è COMANDOS √öTILES

### Testing de B√∫squeda
```bash
# Buscar lugares por texto
curl "http://localhost:3000/api/search/places?query=playa&category=playas-y-costas"

# Buscar lugares cercanos
curl "http://localhost:3000/api/search/nearby?lat=11.5447&lng=-72.9072&radius=5"

# Buscar eventos por fecha
curl "http://localhost:3000/api/search/events?dateRange=2024-06-01,2024-06-30"
```

### Testing de Geolocalizaci√≥n
```bash
# Geocodificaci√≥n inversa
curl -X POST http://localhost:3000/api/geo/reverse \
  -H "Content-Type: application/json" \
  -d '{"lat": 11.5447, "lng": -72.9072}'

# Calcular distancia
curl -X POST http://localhost:3000/api/geo/distance \
  -H "Content-Type: application/json" \
  -d '{
    "from": {"lat": 11.5447, "lng": -72.9072},
    "to": {"lat": 11.5388, "lng": -72.9156}
  }'
```

### Testing de Analytics
```bash
# Estad√≠sticas generales
curl -H "Authorization: Bearer ADMIN_TOKEN" \
  http://localhost:3000/api/analytics/dashboard

# Tendencias
curl http://localhost:3000/api/analytics/trends?period=week
```

### Health Checks
```bash
# Health check general
curl http://localhost:3000/api/health

# Estado de base de datos
curl http://localhost:3000/api/health/database

# Estado de servicios externos
curl http://localhost:3000/api/health/services
```

---

## üìù NOTAS T√âCNICAS

### B√∫squeda Geogr√°fica con Haversine
```typescript
// C√°lculo de distancia entre coordenadas
const haversineDistance = (lat1: number, lon1: number, lat2: number, lon2: number): number => {
  const R = 6371; // Radio de la Tierra en km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
};
```

### Cache Strategy para APIs Externas
```typescript
// Cache simple con TTL
const cache = new Map();
const CACHE_TTL = {
  weather: 60 * 60 * 1000, // 1 hora
  currency: 24 * 60 * 60 * 1000, // 24 horas
  translations: 7 * 24 * 60 * 60 * 1000 // 7 d√≠as
};
```

### Rate Limiting por Endpoint
```typescript
// Configuraci√≥n espec√≠fica por endpoint
const endpointLimits = {
  '/api/search/*': { windowMs: 60000, max: 100 }, // 100/min
  '/api/geo/*': { windowMs: 60000, max: 50 }, // 50/min
  '/api/analytics/*': { windowMs: 60000, max: 20 } // 20/min
};
```

---

## üö® PROBLEMAS COMUNES

### Error: "Search timeout"
- **Causa:** Query muy compleja o base de datos lenta
- **Soluci√≥n:** Optimizar √≠ndices, implementar paginaci√≥n

### Error: "Geocoding service unavailable"
- **Causa:** Servicio externo no disponible
- **Soluci√≥n:** Implementar fallback y cache

### Error: "Analytics calculation failed"
- **Causa:** Datos insuficientes o query compleja
- **Soluci√≥n:** Validar datos, simplificar c√°lculos

### Error: "External API rate limit exceeded"
- **Causa:** L√≠mites de APIs externas
- **Soluci√≥n:** Implementar cache agresivo, m√∫ltiples providers

---

## üìã CHECKLIST DE COMPLETITUD

Al finalizar esta tarea, deber√≠as tener:

- [ ] ‚úÖ Endpoints de b√∫squeda avanzada funcionando
- [ ] ‚úÖ Geolocalizaci√≥n y c√°lculo de distancias
- [ ] ‚úÖ Sistema de analytics y estad√≠sticas
- [ ] ‚úÖ Integraciones con servicios externos
- [ ] ‚úÖ Utilidades espec√≠ficas del dominio
- [ ] ‚úÖ Sistema de notificaciones b√°sico
- [ ] ‚úÖ Herramientas de moderaci√≥n
- [ ] ‚úÖ Health checks y monitoreo
- [ ] ‚úÖ Rate limiting apropiado
- [ ] ‚úÖ Cache strategy implementada

**Estado:** üü° PENDIENTE ‚Üí ‚úÖ COMPLETADO

**Siguiente tarea:** `08-integracion-ia.md`
