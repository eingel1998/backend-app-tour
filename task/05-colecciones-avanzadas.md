# 05 - COLECCIONES AVANZADAS ü§ñ

## üéØ OBJETIVO
Implementar las colecciones m√°s complejas del sistema: Conversations (chat unificado con asistente virtual) y Recommendations (recomendaciones e itinerarios). Estas colecciones manejan la inteligencia artificial y personalizaci√≥n del sistema.

## üìã PREREQUISITOS
- [‚úÖ] Tarea 04 - Colecciones de contenido completada
- [‚úÖ] Places, Reviews, Events funcionando
- [‚úÖ] Todas las relaciones b√°sicas establecidas

## üóÇÔ∏è ESTADO ACTUAL
üü° **PENDIENTE** - No iniciado

---

## üìù TAREAS ESPEC√çFICAS

### 1. COLECCI√ìN CONVERSATIONS (CHAT UNIFICADO) üî•üí¨
**Archivo:** `src/collections/Conversations.ts`

- [ ] **1.1** - Crear estructura b√°sica de la colecci√≥n Conversations
- [ ] **1.2** - Configurar campos de conversaci√≥n:
  ```typescript
  // user: relationship -> users, sessionId, title
  // isActive, language: ['es', 'en', 'wayuu'], lastInteraction
  ```

- [ ] **1.3** - Implementar grupo `userContext` para personalizaci√≥n:
  ```typescript
  // currentLocation: { latitude, longitude, city }
  // preferences: json (copia de user.travelPreferences)
  // sessionData: json (datos temporales)
  ```

- [ ] **1.4** - Configurar grupo `assistantSettings`:
  ```typescript
  // personality: ['friendly', 'professional', 'casual']
  // responseLength: ['short', 'medium', 'detailed']
  // includeRecommendations, autoTranslate
  ```

- [ ] **1.5** - Implementar array embebido `messages` üî•:
  ```typescript
  // id, sender: ['user', 'assistant'], message, messageType
  // messageType: ['text', 'recommendation', 'itinerary', 'question', 'greeting']
  // processingData: { aiModel, processingTime, confidence, tokens }
  // metadata: { recommendedPlaces, generatedItinerary, searchQuery, actionPerformed }
  // isRead, isEdited, editedAt, timestamp
  ```

- [ ] **1.6** - Configurar grupo `statistics` (solo lectura):
  ```typescript
  // totalMessages, avgResponseTime, satisfactionRating, lastRating
  ```

- [ ] **1.7** - Implementar campos de estado:
  ```typescript
  // isArchived, archivedAt
  ```

- [ ] **1.8** - Configurar hooks:
  - afterChange: actualizar lastInteraction
  - afterChange: actualizar statistics.totalMessages
  - beforeCreate: generar sessionId √∫nico

- [ ] **1.9** - Configurar Access Control (usuarios solo sus conversaciones)
- [ ] **1.10** - Configurar admin UI con vista optimizada para mensajes embebidos

### 2. COLECCI√ìN RECOMMENDATIONS (UNIFICADA) üî•‚≠ê
**Archivo:** `src/collections/Recommendations.ts`

- [ ] **2.1** - Crear estructura b√°sica de la colecci√≥n Recommendations
- [ ] **2.2** - Configurar campos comunes:
  ```typescript
  // user: relationship -> users
  // recommendationType: ['place', 'itinerary', 'experience', 'route'] üî• CAMPO CLAVE
  // title, description
  ```

- [ ] **2.3** - Implementar grupo `source` para origen de recomendaci√≥n:
  ```typescript
  // generatedBy: ['ai', 'admin', 'user', 'business']
  // sourceConversation: relationship -> conversations
  // prompt, algorithm
  ```

- [ ] **2.4** - Configurar grupo `context` para personalizaci√≥n:
  ```typescript
  // userPreferences: json, location: { latitude, longitude }
  // timeOfRequest, budget: { min, max, currency }
  // duration, groupSize, specialRequests
  ```

- [ ] **2.5** - Implementar datos espec√≠ficos por tipo - `placeRecommendation`:
  ```typescript
  // places: relationship (many) -> places
  // reason: richText, score: number (0-1)
  // tags: array, visitOrder: array con { place, orderIndex, estimatedTime, notes }
  ```

- [ ] **2.6** - Implementar datos espec√≠ficos por tipo - `itineraryRecommendation`:
  ```typescript
  // name, duration, difficulty: ['easy', 'moderate', 'hard']
  // theme: ['cultural', 'adventure', 'relaxation', 'gastronomic', 'natural', 'mixed']
  // dailySchedule: array con { day, date, activities }
  // activities: { time, place, activity, duration, cost, notes, transportation }
  // estimatedCosts: { accommodation, food, transportation, activities, total, currency }
  // includedServices, recommendations: { bestTimeToVisit, packingList, tips, warnings }
  ```

- [ ] **2.7** - Implementar datos espec√≠ficos por tipo - `experienceRecommendation`:
  ```typescript
  // experienceType: ['adventure', 'cultural', 'gastronomic', 'wellness', 'educational']
  // provider: relationship -> users (business)
  // places: relationship (many) -> places
  // activities: array, price: { amount, currency, includes }
  ```

- [ ] **2.8** - Configurar estados y m√©tricas:
  ```typescript
  // status: ['draft', 'active', 'expired', 'archived']
  // isPublic, isBookable, expiresAt
  // engagement: { wasViewed, wasAccepted, wasBooked, wasShared, viewedAt, sharedCount }
  // feedback: { rating, comment, ratedAt }
  ```

- [ ] **2.9** - Configurar campos condicionales seg√∫n recommendationType
- [ ] **2.10** - Implementar hooks para validaci√≥n de datos seg√∫n tipo
- [ ] **2.11** - Configurar Access Control (usuarios ven sus recomendaciones, p√∫blicas si isPublic)

### 3. ENDPOINTS PERSONALIZADOS PARA CHAT
**Archivo:** `src/endpoints/chat.ts`

- [ ] **3.1** - Crear endpoint `/api/chat/start` para iniciar conversaci√≥n:
  ```typescript
  // POST: crear nueva conversaci√≥n con contexto del usuario
  // Retorna: conversationId y configuraci√≥n inicial
  ```

- [ ] **3.2** - Crear endpoint `/api/chat/:conversationId/message` para enviar mensaje:
  ```typescript
  // POST: agregar mensaje del usuario + procesar con IA + respuesta
  // Retorna: mensaje de respuesta del asistente
  ```

- [ ] **3.3** - Crear endpoint `/api/chat/:conversationId/context` para actualizar contexto:
  ```typescript
  // PATCH: actualizar ubicaci√≥n, preferencias del usuario
  // Permite personalizaci√≥n en tiempo real
  ```

- [ ] **3.4** - Crear endpoint `/api/chat/history` para historial:
  ```typescript
  // GET: listar conversaciones del usuario con √∫ltima actividad
  ```

### 4. ENDPOINTS PERSONALIZADOS PARA RECOMMENDATIONS
**Archivo:** `src/endpoints/recommendations.ts`

- [ ] **4.1** - Crear endpoint `/api/recommendations/generate` para generar recomendaci√≥n:
  ```typescript
  // POST: generar recomendaci√≥n basada en prompt y contexto
  // Par√°metros: type, context, preferences
  // Retorna: recomendaci√≥n generada
  ```

- [ ] **4.2** - Crear endpoint `/api/recommendations/itinerary` para itinerarios espec√≠ficos:
  ```typescript
  // POST: generar itinerario detallado
  // Par√°metros: duration, budget, interests, groupSize
  // Retorna: itinerario completo con cronograma
  ```

- [ ] **4.3** - Crear endpoint `/api/recommendations/nearby` para recomendaciones por ubicaci√≥n:
  ```typescript
  // GET: recomendaciones basadas en ubicaci√≥n actual
  // Par√°metros: latitude, longitude, radius
  ```

- [ ] **4.4** - Crear endpoint `/api/recommendations/:id/feedback` para feedback:
  ```typescript
  // POST: permitir al usuario calificar recomendaci√≥n
  // Mejora el algoritmo de recomendaciones futuras
  ```

### 5. INTEGRACI√ìN CON IA (PREPARACI√ìN)
**Archivo:** `src/services/aiService.ts`

- [ ] **5.1** - Crear estructura base para servicio de IA:
  ```typescript
  // Interfaces para prompt engineering
  // Funciones de procesamiento de contexto
  // Integraci√≥n con proveedores de IA (OpenAI, Anthropic, etc.)
  ```

- [ ] **5.2** - Implementar procesamiento de mensajes de chat:
  ```typescript
  // processUserMessage: analizar intent y contexto
  // generateResponse: crear respuesta personalizada
  // extractRecommendations: identificar lugares para recomendar
  ```

- [ ] **5.3** - Implementar generaci√≥n de recomendaciones:
  ```typescript
  // generatePlaceRecommendations: basado en preferencias
  // generateItinerary: crear cronograma detallado
  // generateExperience: sugerir experiencias espec√≠ficas
  ```

- [ ] **5.4** - Configurar prompt templates para Riohacha:
  ```typescript
  // Templates espec√≠ficos para turismo en La Guajira
  // Conocimiento sobre cultura Wayuu
  // Informaci√≥n sobre clima y temporadas
  ```

### 6. WEBSOCKETS PARA CHAT EN TIEMPO REAL
**Archivo:** `src/lib/websocket.ts`

- [ ] **6.1** - Configurar WebSocket server b√°sico
- [ ] **6.2** - Implementar rooms por conversaci√≥n
- [ ] **6.3** - Configurar eventos de chat:
  - user_message: mensaje del usuario
  - assistant_typing: asistente escribiendo
  - assistant_message: respuesta del asistente
  - conversation_updated: cambios en conversaci√≥n

- [ ] **6.4** - Implementar autenticaci√≥n para WebSockets
- [ ] **6.5** - Configurar heartbeat y reconexi√≥n autom√°tica

### 7. TESTING DE FUNCIONALIDADES AVANZADAS
- [ ] **7.1** - Probar creaci√≥n de conversaci√≥n completa
- [ ] **7.2** - Probar array embebido de mensajes
- [ ] **7.3** - Probar generaci√≥n de recomendaciones por tipo
- [ ] **7.4** - Probar endpoints personalizados de chat
- [ ] **7.5** - Probar endpoints de recomendaciones
- [ ] **7.6** - Verificar funcionamiento de WebSockets b√°sico

---

## ‚úÖ CRITERIOS DE ACEPTACI√ìN

### Colecci√≥n Conversations
- [ ] Conversaciones se crean con contexto del usuario
- [ ] Array de mensajes embebidos funciona correctamente
- [ ] SessionId √∫nico se genera autom√°ticamente
- [ ] Hooks de actualizaci√≥n funcionan
- [ ] WebSockets b√°sicos funcionan para chat en tiempo real

### Colecci√≥n Recommendations
- [ ] Tres tipos de recomendaciones funcionan (place, itinerary, experience)
- [ ] Campos condicionales aparecen seg√∫n recommendationType
- [ ] Contexto y origen se guardan correctamente
- [ ] Sistema de feedback funciona
- [ ] Recomendaciones p√∫blicas/privadas se manejan apropiadamente

### Endpoints Personalizados
- [ ] Chat endpoints funcionan completamente
- [ ] Recommendations endpoints generan contenido
- [ ] Autenticaci√≥n funciona en todos los endpoints
- [ ] Manejo de errores implementado

### Integraci√≥n IA (Preparaci√≥n)
- [ ] Estructura base para IA configurada
- [ ] Prompt templates para Riohacha creados
- [ ] Servicios de procesamiento preparados
- [ ] Interfaces definidas para futura integraci√≥n

---

## üõ†Ô∏è COMANDOS √öTILES

### Desarrollo
```bash
# Generar tipos para nuevas colecciones
npm run generate:types

# Probar WebSockets localmente
npm run dev
# Usar herramienta como Postman para WebSocket testing
```

### Testing API - Chat
```bash
# Iniciar nueva conversaci√≥n
curl -X POST http://localhost:3000/api/chat/start \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"context": {"location": {"latitude": 11.5447, "longitude": -72.9072}}}'

# Enviar mensaje
curl -X POST http://localhost:3000/api/chat/CONVERSATION_ID/message \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message": "¬øQu√© puedo hacer en Riohacha hoy?", "messageType": "text"}'

# Ver historial
curl -H "Authorization: Bearer TOKEN" \
  http://localhost:3000/api/chat/history
```

### Testing API - Recommendations
```bash
# Generar recomendaci√≥n de lugares
curl -X POST http://localhost:3000/api/recommendations/generate \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "type": "place",
    "context": {"budget": {"max": 100000, "currency": "COP"}},
    "preferences": {"interests": ["playa", "cultura"]}
  }'

# Generar itinerario
curl -X POST http://localhost:3000/api/recommendations/itinerary \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "duration": 3,
    "budget": {"max": 500000, "currency": "COP"},
    "groupSize": 2,
    "interests": ["adventure", "cultural"]
  }'
```

### Base de Datos
```bash
# Ver conversaciones creadas
sqlite3 backend-app.db "SELECT id, title, language FROM conversations LIMIT 5;"

# Ver mensajes en conversaciones
sqlite3 backend-app.db "SELECT json_extract(messages, '$[0].message') FROM conversations WHERE messages IS NOT NULL LIMIT 3;"

# Ver recomendaciones por tipo
sqlite3 backend-app.db "SELECT recommendationType, title FROM recommendations LIMIT 5;"
```

---

## üìù NOTAS T√âCNICAS

### Array Embebido de Mensajes
```typescript
// Configuraci√≥n optimizada para mensajes embebidos
{
  name: 'messages',
  type: 'array',
  admin: {
    initCollapsed: true,
    components: {
      RowLabel: ({ data, index }) => data?.message?.slice(0, 50) || `Mensaje ${index + 1}`
    }
  },
  fields: [
    // campos de mensaje
  ]
}
```

### Campos Condicionales por Tipo
```typescript
// Solo mostrar campos relevantes seg√∫n recommendationType
{
  name: 'placeRecommendation',
  type: 'group',
  admin: {
    condition: (data) => data.recommendationType === 'place'
  },
  fields: [ /* campos espec√≠ficos para places */ ]
}
```

### WebSocket Authentication
```typescript
// Verificar token en WebSocket connection
const authenticate = (socket, next) => {
  const token = socket.handshake.auth.token;
  // Verificar JWT token
  jwt.verify(token, process.env.PAYLOAD_SECRET, (err, decoded) => {
    if (err) return next(new Error('Authentication error'));
    socket.userId = decoded.id;
    next();
  });
};
```

### Prompt Engineering para Riohacha
```typescript
const RIOHACHA_CONTEXT = `
Eres un asistente virtual especializado en turismo para Riohacha, La Guajira, Colombia.
Conocimientos clave:
- Clima: c√°lido y seco, mejor temporada diciembre-abril
- Cultura: fuerte presencia Wayuu, artesan√≠as tradicionales
- Atractivos: playas, desierto, cabo de la vela
- Gastronom√≠a: fritos, arepa de huevo, chivo, pescados
- Idiomas: espa√±ol y wayuunaiki
`;
```

---

## üö® PROBLEMAS COMUNES

### Error: "Messages array too large"
- **Causa:** Array de mensajes muy extenso
- **Soluci√≥n:** Implementar paginaci√≥n o archivado autom√°tico

### Error: "WebSocket connection failed"
- **Causa:** Configuraci√≥n de puerto o autenticaci√≥n
- **Soluci√≥n:** Verificar configuraci√≥n de WebSocket server

### Error: "Recommendation type not found"
- **Causa:** recommendationType no v√°lido
- **Soluci√≥n:** Validar tipo antes de procesar

### Error: "Context parsing failed"
- **Causa:** JSON mal formado en campos de contexto
- **Soluci√≥n:** Validar JSON antes de guardar

---

## üìã CHECKLIST DE COMPLETITUD

Al finalizar esta tarea, deber√≠as tener:

- [ ] ‚úÖ Colecci√≥n Conversations con mensajes embebidos
- [ ] ‚úÖ Colecci√≥n Recommendations con 3 tipos diferenciados
- [ ] ‚úÖ Endpoints personalizados de chat funcionando
- [ ] ‚úÖ Endpoints de recomendaciones funcionando
- [ ] ‚úÖ WebSockets b√°sicos para chat en tiempo real
- [ ] ‚úÖ Estructura de servicio de IA preparada
- [ ] ‚úÖ Prompt templates para turismo en Riohacha
- [ ] ‚úÖ Sistema de feedback para recomendaciones
- [ ] ‚úÖ Access Control apropiado para ambas colecciones
- [ ] ‚úÖ Testing b√°sico de todas las funcionalidades

**Estado:** üü° PENDIENTE ‚Üí ‚úÖ COMPLETADO

**Siguiente tarea:** `06-autenticacion-autorizacion.md`

## üß™ TESTS ESPEC√çFICOS DE LA TAREA

### Tests Obligatorios para Completar la Tarea
Esta tarea solo estar√° **COMPLETA** cuando **TODOS** los siguientes tests pasen:

#### **üìÅ Estructura de Tests: `test/tasks/task-05/`**

##### **1. `conversations-collection.test.ts` - Tests de Colecci√≥n Conversations**
```typescript
describe('Task 05 - Conversations Collection', () => {
  test('should have Conversations collection with chat structure', async () => {
    // Verificar estructura b√°sica de Conversations.ts
    // Test de campos: user, sessionId, title, isActive
    // Verificar soporte multiidioma (es, en, wayuu)
  });

  test('should handle user context for personalization', async () => {
    // Test de grupo userContext
    // Verificar currentLocation con coordenadas
    // Test de preferences y sessionData JSON
  });

  test('should manage assistant settings correctly', async () => {
    // Test de assistantSettings
    // Verificar personality options
    // Test de responseLength y configuraciones
  });

  test('should handle embedded messages array properly', async () => {
    // Test de array messages embebido
    // Verificar estructura de mensajes (sender, messageType)
    // Test de processingData con m√©tricas de IA
  });

  test('should manage conversation statistics', async () => {
    // Test de grupo statistics (solo lectura)
    // Verificar c√°lculos autom√°ticos
    // Test de m√©tricas de uso y performance
  });

  test('should support multilingual conversations', async () => {
    // Test de conversaciones en espa√±ol
    // Test de conversaciones en ingl√©s
    // Test de soporte para idioma wayuu
  });
});
```

##### **2. `recommendations-collection.test.ts` - Tests de Colecci√≥n Recommendations**
```typescript
describe('Recommendations Collection Tests', () => {
  test('should have Recommendations collection with AI-powered structure', async () => {
    // Verificar estructura de Recommendations.ts
    // Test de campos: user, type, title, description
    // Verificar relaci√≥n con conversaciones
  });

  test('should handle different recommendation types', async () => {
    // Test de types: place, itinerary, event, experience
    // Verificar estructura espec√≠fica por tipo
    // Test de validaciones condicionales
  });

  test('should manage itinerary data correctly', async () => {
    // Test de grupo itinerary
    // Verificar estructura de d√≠as y actividades
    // Test de c√°lculos de duraci√≥n y costos
  });

  test('should handle AI generation metadata', async () => {
    // Test de aiGeneration group
    // Verificar modelo usado, tokens, confidence
    // Test de prompts y par√°metros de generaci√≥n
  });

  test('should manage user feedback and ratings', async () => {
    // Test de userFeedback
    // Verificar rating, implementation status
    // Test de feedback para mejora del algoritmo
  });

  test('should calculate personalization scores', async () => {
    // Test de personalizationScore
    // Verificar factores de personalizaci√≥n
    // Test de weights para diferentes criterios
  });
});
```

##### **3. `ai-integration.test.ts` - Tests de Integraci√≥n con IA**
```typescript
describe('AI Integration Tests', () => {
  test('should integrate with AI service for conversations', async () => {
    // Test de integraci√≥n con servicio de IA
    // Verificar procesamiento de mensajes
    // Test de respuesta contextual
  });

  test('should generate recommendations based on user data', async () => {
    // Test de generaci√≥n de recomendaciones
    // Verificar uso de preferencias de usuario
    // Test de algoritmo de personalizaci√≥n
  });

  test('should handle AI processing metadata correctly', async () => {
    // Test de almacenamiento de metadata de IA
    // Verificar tokens utilizados
    // Test de confidence scores
  });

  test('should support contextual recommendations', async () => {
    // Test de recomendaciones contextuales
    // Verificar uso de ubicaci√≥n actual
    // Test de recomendaciones basadas en historial
  });

  test('should handle AI service errors gracefully', async () => {
    // Test de manejo de errores de servicio IA
    // Verificar fallbacks y respuestas de emergencia
    // Test de retry mechanisms
  });
});
```

##### **4. `advanced-collections-integration.test.ts` - Tests de Integraci√≥n Avanzada**
```typescript
describe('Advanced Collections Integration Tests', () => {
  test('should integrate conversations with recommendations', async () => {
    // Test de relaci√≥n conversations -> recommendations
    // Verificar generaci√≥n autom√°tica de recomendaciones
    // Test de continuidad de contexto
  });

  test('should handle complex user journey tracking', async () => {
    // Test de seguimiento de journey completo
    // Verificar datos de sesi√≥n persistentes
    // Test de analytics de conversaciones
  });

  test('should support real-time conversation updates', async () => {
    // Test de actualizaciones en tiempo real
    // Verificar websockets o polling
    // Test de sincronizaci√≥n de mensajes
  });

  test('should manage conversation and recommendation lifecycle', async () => {
    // Test de archivado de conversaciones antiguas
    // Verificar limpieza de datos temporales
    // Test de retention policies
  });

  test('should handle privacy and data protection', async () => {
    // Test de anonimizaci√≥n de datos sensibles
    // Verificar cumplimiento de privacidad
    // Test de exportaci√≥n/eliminaci√≥n de datos
  });
});
```

##### **5. `advanced-performance.test.ts` - Tests de Rendimiento Avanzado**
```typescript
describe('Advanced Performance Tests', () => {
  test('should handle concurrent conversations efficiently', async () => {
    // Test de m√∫ltiples conversaciones simult√°neas
    // Verificar performance con muchos usuarios activos
    // Test de gesti√≥n de memoria con arrays embebidos
  });

  test('should optimize AI processing and response times', async () => {
    // Test de tiempos de respuesta de IA
    // Verificar caching de respuestas comunes
    // Test de optimizaci√≥n de tokens
  });

  test('should handle large recommendation datasets', async () => {
    // Test con muchas recomendaciones almacenadas
    // Verificar queries de recomendaciones personalizadas
    // Test de algoritmos de ranking eficientes
  });

  test('should manage conversation history efficiently', async () => {
    // Test de queries en historiales largos
    // Verificar paginaci√≥n de mensajes
    // Test de compresi√≥n de datos antiguos
  });
});
```

### **üìä Comandos de Validaci√≥n**

#### **Ejecutar Tests de la Tarea 05:**
```bash
npm run test:task-05
```

#### **Ejecutar Tests con Coverage:**
```bash
npm run test:task-05:coverage
```

#### **Validaci√≥n Autom√°tica de Completitud:**
```bash
node scripts/validate-task.js 05
```

### **‚úÖ Criterios de Completitud**
- [ ] üß™ **TODOS los tests pasan** (100% success rate)
- [ ] üìä **Coverage >80%** en colecciones avanzadas
- [ ] üîç **Validaci√≥n autom√°tica exitosa** con `validate-task.js 05`
- [ ] ü§ñ **Tests de integraci√≥n IA exitosos**
- [ ] ‚ö° **Performance tests pasan** con datasets complejos
- [ ] üîó **Tests de integraci√≥n avanzada funcionando**

---

## ‚ö†Ô∏è IMPORTANTE
**Esta tarea NO estar√° completa hasta que TODOS los tests pasen exitosamente.**

El comando `npm run test:task-05` debe ejecutarse sin errores y todos los tests deben estar en estado ‚úÖ PASSED.

---
